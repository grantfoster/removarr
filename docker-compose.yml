version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: removarr-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-removarr}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-removarr}
      POSTGRES_DB: ${POSTGRES_DB:-removarr}
    volumes:
      - removarr-postgres-data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"  # Bind to localhost so removarr (on host network) can access it
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-removarr}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  removarr:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: removarr
    # Use host network mode so localhost works (for accessing Overseerr, Sonarr, etc.)
    # Note: depends_on doesn't work with host network mode, so we wait for DB in startup script
    network_mode: host
    environment:
      # Database connection (use localhost since we're on host network)
      # PostgreSQL port is mapped to 127.0.0.1:5432 in the postgres service
      REMOVARR_DB_HOST: localhost
      REMOVARR_DB_PORT: 5432
      REMOVARR_DB_USER: ${POSTGRES_USER:-removarr}
      REMOVARR_DB_PASSWORD: ${POSTGRES_PASSWORD:-removarr}
      REMOVARR_DB_DATABASE: ${POSTGRES_DB:-removarr}
      REMOVARR_DB_SSLMODE: disable
      
      # Session secret (generate a random one if not provided)
      REMOVARR_SESSION_SECRET: ${SESSION_SECRET:-}
      
      # Server settings (optional overrides)
      REMOVARR_HOST: ${REMOVARR_HOST:-0.0.0.0}
      REMOVARR_PORT: ${REMOVARR_PORT:-31111}
    volumes:
      # Optional: Mount config.yaml if you want to customize server/database settings
      # If not mounted, the app will auto-generate one from environment variables
      # - ./config.yaml:/app/config.yaml:ro
      - removarr-data:/app/data  # For persistent storage if needed
    # Using host network mode, so no port mapping needed
    # The container will bind directly to the host's port 31111
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - |
        if [ ! -f config.yaml ]; then
          echo 'Creating config.yaml from environment variables...'
          cat > config.yaml <<'EOFCONFIG'
        server:
          host: 0.0.0.0
          port: 31111
        database:
          host: localhost
          port: 5432
          user: removarr
          password: removarr
          database: removarr
          ssl_mode: disable
        logging:
          level: info
          format: json
        EOFCONFIG
        fi
        echo 'Waiting for database...'
        until pg_isready -h localhost -U removarr -d removarr; do sleep 1; done
        echo 'Running migrations...'
        ./migrate -config config.yaml -cmd up
        echo 'Starting Removarr...'
        ./removarr -config config.yaml

volumes:
  removarr-postgres-data:
    driver: local
  removarr-data:
    driver: local

